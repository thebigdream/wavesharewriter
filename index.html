<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Waveshare NFC E-Paper Writer</title>
</head>
<body>
<h1>Waveshare NFC E-Paper Writer</h1>
<button id="scanButton">Scan</button>
<button id="writeButton">Write Checkerboard</button>
<button id="wipeButton">Wipe Display</button>
<pre id="log"></pre>

<script>
const log = (...args) => {
  document.getElementById('log').textContent += args.join(' ') + '\n';
};

const WIDTH = 640;
const HEIGHT = 384;

// Generate 1-bit checkerboard
function generateCheckerboard() {
  const bytesPerRow = WIDTH / 8;
  const buffer = new Uint8Array(bytesPerRow * HEIGHT);

  for (let y = 0; y < HEIGHT; y++) {
    for (let xByte = 0; xByte < bytesPerRow; xByte++) {
      let byte = 0;
      for (let bit = 0; bit < 8; bit++) {
        const x = xByte * 8 + bit;
        if (((Math.floor(x/8) + Math.floor(y/8)) % 2) === 0) byte |= (1 << (7-bit));
      }
      buffer[y * bytesPerRow + xByte] = byte;
    }
  }
  return buffer;
}

// Generate blank image (all white)
function generateBlankImage() {
  const bytesPerRow = WIDTH / 8;
  return new Uint8Array(bytesPerRow * HEIGHT); // all zeros = white
}

// Split into 256-byte blocks with Waveshare-compatible header
function createBlocks(pixelBuffer) {
  const BLOCK_SIZE = 256;
  const HEADER_SIZE = 16;
  const blocks = [];
  const filename = 'generic_640x384.bin';
  const totalBlocks = Math.ceil(pixelBuffer.length / (BLOCK_SIZE - HEADER_SIZE));

  for (let i = 0; i < totalBlocks; i++) {
    const start = i * (BLOCK_SIZE - HEADER_SIZE);
    const end = Math.min(start + (BLOCK_SIZE - HEADER_SIZE), pixelBuffer.length);
    const chunk = pixelBuffer.slice(start, end);

    const block = new Uint8Array(BLOCK_SIZE);

    // Header
    block[0] = 0x57; block[1] = 0x53; block[2] = 0x44; block[3] = 0x5A;
    // Version / command bytes
    block[4] = 0x31; block[5] = 0x30;
    // Filename in ASCII (6 bytes)
    for (let j = 0; j < filename.length && j < 6; j++) block[6+j] = filename.charCodeAt(j);
    // Reserved / flags
    block[12] = 0xFF; block[13] = 0x00; block[14] = 0x00; block[15] = 0x00;
    // Minimal checksum
    let checksum = 0;
    for (let b of chunk) checksum ^= b;
    block[0x10] = checksum;
    // Pixel data
    block.set(chunk, HEADER_SIZE);

    blocks.push(block);
  }

  return blocks;
}

// Write blocks via WebNFC sequentially
async function writeBlocksNFC(blocks) {
  try {
    const ndef = new NDEFReader();
    log("> Waiting for NFC scan...");
    await ndef.scan();
    log("> Scan started");

    for (let i = 0; i < blocks.length; i++) {
      await ndef.write({
        records: [{
          recordType: "mime",
          mediaType: "application/octet-stream",
          data: blocks[i]
        }]
      });
      log(`> Block ${i+1}/${blocks.length} sent`);
      await new Promise(r => setTimeout(r, 50));
    }

    log("> All blocks sent! Display should refresh.");
  } catch (err) {
    log("Argh! " + err);
  }
}

// Button handlers
document.getElementById('scanButton').addEventListener('click', async () => {
  try {
    const ndef = new NDEFReader();
    await ndef.scan();
    log("> Scan started");
    ndef.addEventListener("readingerror", () => log("Cannot read NFC tag."));
    ndef.addEventListener("reading", ({ serialNumber, message }) => {
      log(`> Serial Number: ${serialNumber}, Records: ${message.records.length}`);
    });
  } catch (err) { log("Argh! " + err); }
});

document.getElementById('writeButton').addEventListener('click', async () => {
  const pixels = generateCheckerboard();
  const blocks = createBlocks(pixels);
  await writeBlocksNFC(blocks);
});

document.getElementById('wipeButton').addEventListener('click', async () => {
  const pixels = generateBlankImage();
  const blocks = createBlocks(pixels);
  await writeBlocksNFC(blocks);
});
</script>
</body>
</html>
