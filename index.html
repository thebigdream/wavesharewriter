<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="Waveshare 7.5-inch NFC E-Paper Checkerboard Demo">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Waveshare Writer</title>
  <link rel="icon" href="../images/favicon.ico">
  <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
  <h1>Waveshare NFC E-Paper Demo</h1>

  <button id="scanButton">Scan</button>
  <button id="writeButton">Write Checkerboard</button>
  <button id="makeReadOnlyButton">Make Read-Only</button>

  <h3>Live Output</h3>
  <div id="output" class="output">
    <div id="content"></div>
    <div id="status">Web NFC is not available. Use Chrome on Android.</div>
    <pre id="log"></pre>
  </div>

<script>
  // Logger (ChromeSamples style)
  var ChromeSamples = {
    log: function() {
      var line = Array.prototype.slice.call(arguments)
        .map(arg => typeof arg === 'string' ? arg : JSON.stringify(arg))
        .join(' ');
      document.querySelector('#log').textContent += line + '\n';
    },
    clearLog: function() { document.querySelector('#log').textContent = ''; },
    setStatus: function(status) { document.querySelector('#status').textContent = status; },
    setContent: function(newContent) {
      const content = document.querySelector('#content');
      while (content.hasChildNodes()) content.removeChild(content.lastChild);
      content.appendChild(newContent);
    }
  };

  const log = ChromeSamples.log;

  // WebNFC availability check
  if (!("NDEFReader" in window)) {
    ChromeSamples.setStatus("Web NFC is not available. Use Chrome on Android.");
  } else {
    ChromeSamples.setStatus("Web NFC is available. Ready!");
  }

  // 7.5-inch display size
  const WIDTH = 640;
  const HEIGHT = 384;

  // Generate full-screen checkerboard (1-bit, MSB-first)
  function generateCheckerboard() {
    const bytesPerRow = WIDTH / 8;
    const buffer = new Uint8Array(bytesPerRow * HEIGHT);

    for (let y = 0; y < HEIGHT; y++) {
      for (let xByte = 0; xByte < bytesPerRow; xByte++) {
        let byte = 0;
        for (let bit = 0; bit < 8; bit++) {
          const x = xByte * 8 + bit;
          const isBlack = ((Math.floor(x / 8) + Math.floor(y / 8)) % 2) === 0;
          if (isBlack) byte |= (1 << (7 - bit));
        }
        buffer[y * bytesPerRow + xByte] = byte;
      }
    }
    return buffer;
  }

  // Write in chunks to avoid NFC IO errors
  async function writeInChunks(ndef, buffer, chunkSize = 512) {
    const totalChunks = Math.ceil(buffer.byteLength / chunkSize);

    for (let i = 0; i < totalChunks; i++) {
      const start = i * chunkSize;
      const end = Math.min((i + 1) * chunkSize, buffer.byteLength);
      const chunk = buffer.slice(start, end);

      try {
        await ndef.write({
          records: [{
            recordType: "mime",
            mediaType: "application/octet-stream",
            data: chunk
          }]
        });
        log(`> Chunk ${i + 1}/${totalChunks} sent`);
      } catch (error) {
        log(`Argh! Error sending chunk ${i + 1}: ${error}`);
        throw error;
      }

      // Short delay to prevent NFC overload
      await new Promise(resolve => setTimeout(resolve, 50));
    }

    log("> All chunks sent!");
  }

  // Scan button
  document.getElementById("scanButton").addEventListener("click", async () => {
    log("User clicked scan button");

    try {
      const ndef = new NDEFReader();
      await ndef.scan();
      log("> Scan started");

      ndef.addEventListener("readingerror", () => {
        log("Argh! Cannot read data from the NFC tag. Try another one?");
      });

      ndef.addEventListener("reading", ({ message, serialNumber }) => {
        log(`> Serial Number: ${serialNumber}`);
        log(`> Records: (${message.records.length})`);
      });
    } catch (error) {
      log("Argh! " + error);
    }
  });

  // Write checkerboard button
  document.getElementById("writeButton").addEventListener("click", async () => {
    log("User clicked write checkerboard button");

    try {
      const checkerboard = generateCheckerboard();
      const ndef = new NDEFReader();

      await writeInChunks(ndef, checkerboard, 512);
    } catch (error) {
      log("Argh! " + error);
    }
  });

  // Make read-only button
  document.getElementById("makeReadOnlyButton").addEventListener("click", async () => {
    log("User clicked make read-only button");

    try {
      const ndef = new NDEFReader();
      await ndef.makeReadOnly();
      log("> NFC tag has been made permanently read-only");
    } catch (error) {
      log("Argh! " + error);
    }
  });
</script>
</body>
</html>
